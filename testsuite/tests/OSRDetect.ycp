/**
 *  Test for running automatic detection
 *  Author:	Jiri Suchomel <jsuchome@suse.cz>
 *  $Id$
 */

{
    // testedfiles: OSRRepairUI.ycp OSR.ycp OSRCommon.ycp osr_module_partition.ycp OSRFstab.ycp

    import "Testsuite";

    map I_READ = $[
	"probe" : $[
	    "cdrom"	: [],
	    "is_uml"	: false,
	    "floppy"	: $[
		"manual"	: [ $[] ] // 1 floppy for "init_floppy" method
	    ],
	    "architecture"	: ""
	],
	"etc"	: $[
	    "mtab"	: []
	],
	"proc"	: $[
	    "modules"	: $[],
	    "swaps"	: [],
	    "mounts"	: [ $["file": "/" , "spec": "/dev/hda3"]],
	],
	"target" : $[
	    "size"	: -1,
	    "tmpdir"	: "/tmp/",
	],
	"product"	: $[
	    "features"	: $[
		"USE_DESKTOP_SCHEDULER"	: "",
		"IO_SCHEDULER"		: "",
		"UI_MODE"		: "",
		"ENABLE_AUTOLOGIN"	: "",
		"EVMS_CONFIG"		: ""
	    ],
	],
    ];

    map I_EXEC = $[
	"target": $[
	    "bash_output" : $[],
	],
    ];
    Testsuite::Init ( [I_READ, $[], I_EXEC], nil);

    import "Mode";

    Mode::SetTest ("testsuite");

    import "OSR";
    import "OSRCommon";
    import "OSRStatus";

    map READ	= $[
	"target" : $[
	    "yast2"	: $[],
	    "size"	: 1,
	    "string"	: "/dev/hda3 / reiserfs acl,user_xattr 1 1",//fstab
	    "tmpdir"	: "/tmp/",
	    "ycp"	: $[],
	],
	"md"	: $[
	    "config"	: $[],
	],
	"lvm"	: $[
	    "vg"	: $[],
	    "pv"	: $[],
	],
	"evms"	: $[
	    "container"	: [],
	    "volume"	: [],
	],
	"probe" : $[
	    "boot_disk"	: "",
	    "disk"	: [],
	    "floppy"	: [ $[] ],

	    "cdrom"	: [],
	    "is_uml"	: false,
	    "floppy"	: $[
		"manual"	: [ $[] ] // 1 floppy for "init_floppy" method
	    ],
	    "architecture"	: ""
	],
	"proc"	: $[
	    "swaps"	: [ ],
	    "mounts"	: [ $["file": "/" , "spec": "/dev/hda3"],
			    $["file": "/mnt" , "spec": "/dev/hda3"] ],
	    "modules"	: $[],
	],
	"etc"	: $[
	    "mtab"	: [ $["file": "/"] ],
	    "install_inf"	: $[
		"Cdrom"	: "",
	    ],
	],
	"sysconfig"	: $[
	    "kernel"	: $[
		"INITRD_MODULES"	: "",
	    ],
	    "bootloader": $[
		"LOADER_TYPE"		: "grub",
	    ],
	    "language"	: $[
		"RC_LANG"		: "",
		"DEFAULT_LANGUAGE"	: "",
		"ROOT_USES_LANG"	: "",
		"LANGUAGES"		: "",
	    ],
	],
	"xml"		: $[],
	"grub"		: [],
	"bootloader"	: $[
	    "settings"	: $[],
	],
    ];
    map WRITE	= $[];
    map EXEC	= $[
	"target": $[
	    "bash_output" : $[],
	],
    ];

    Testsuite::Dump (sformat ("global entries: %1", OSRCommon::global_entries));
    Testsuite::Test (``(OSR::Init ()), [READ, WRITE, EXEC], 0);
    Testsuite::Dump (sformat ("global entries (keys): %1", maplist (
	string k, map m, (map<string,map>)OSRCommon::global_entries, ``(k))));

    Testsuite::Dump (sformat ("detect group: %1", OSR::DetectGroupList ()));

    Testsuite::Test (``(OSR::SelectDefaultDetectGroups ()), [READ, WRITE, EXEC], 0);

    Testsuite::Dump (sformat ("detect group: %1", OSR::DetectGroupList ()));

    Testsuite::Dump ("----------------- start detection [no hard disk found]: ------");

    Testsuite::Test (``(OSR::Detect ()), [READ, WRITE, EXEC], 0);

    Testsuite::Dump ("--------------------------------------------------------------");

    Testsuite::Dump (sformat ("--- status: %1", OSRStatus::status));

    Testsuite::Dump (sformat ("--- failed in module: %1", OSRCommon::current_module_name));

    Testsuite::Dump ("----------------- start detection [hard disks now ok]: --------");

    READ["target","yast2"]	= $[
	"/dev/hda": $[
	    "device"	: "/dev/hda",
	    "type"      : `CT_DISK,
	    "partitions": [
		$[
		    "detected_fs":`reiser,
		    "device"	: "/dev/hda3",
		    "mount"	: "/",
		    "nr"	: 3
		],
		$[
		    "fsid" : 130,
		    "device"	: "/dev/hda1",
		    "nr"	: 1
		]
	    ]
	]
    ];

    Testsuite::Test (``(OSR::Detect ()), [READ, WRITE, EXEC], 0);
}
